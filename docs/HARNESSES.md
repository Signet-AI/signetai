# Harnesses

Harnesses are the AI platforms and tools that Signet integrates with. Signet syncs your agent identity and memory to each one.

---

## How Harness Sync Works

When you change `~/.agents/AGENTS.md`:

1. The daemon file watcher detects the change (within 2 seconds)
2. The daemon reads the new content
3. It prepends an auto-generated header identifying the source
4. It writes the result to each configured harness location

The header looks like this:

```
# CLAUDE.md
# ============================================================================
# AUTO-GENERATED from ~/.agents/AGENTS.md by Signet
# Generated: 2025-02-17T18:00:00.000Z
# 
# DO NOT EDIT THIS FILE - changes will be overwritten
# Edit the source file instead: ~/.agents/AGENTS.md
#
# Related documents:
#   - ~/.agents/SOUL.md (Personality & tone)
#   - ~/.agents/MEMORY.md (Working memory context)
#   - ~/.agents/agent.yaml (Configuration & settings)
#
# Memory commands: /remember <content> | /recall <query>
# ============================================================================
```

You can also trigger a manual re-sync:
```bash
curl -X POST http://localhost:3850/api/harnesses/regenerate
```

---

## Claude Code

Claude Code is Anthropic's official CLI for Claude. It reads configuration from `~/.claude/`.

### Files managed by Signet

| File | Description |
|------|-------------|
| `~/.claude/CLAUDE.md` | Auto-synced from `~/.agents/AGENTS.md` |
| `~/.claude/settings.json` | Hook configuration (written once during setup) |

### Memory hooks

Signet writes hooks to `~/.claude/settings.json` that fire at session lifecycle events:

```json
{
  "hooks": {
    "SessionStart": [{
      "hooks": [{
        "type": "command",
        "command": "python3 ~/.agents/memory/scripts/memory.py load --mode session-start",
        "timeout": 3000
      }]
    }],
    "UserPromptSubmit": [{
      "hooks": [{
        "type": "command",
        "command": "python3 ~/.agents/memory/scripts/memory.py load --mode prompt",
        "timeout": 2000
      }]
    }],
    "SessionEnd": [{
      "hooks": [{
        "type": "command",
        "command": "python3 ~/.agents/memory/scripts/memory.py save --mode auto",
        "timeout": 10000
      }]
    }]
  }
}
```

**SessionStart** — loads memories and context, outputs them as text that Claude Code injects into the system prompt.

**UserPromptSubmit** — optionally loads per-prompt context (lighter weight than session start).

**SessionEnd** — automatically saves a session summary to memory.

### Using /remember and /recall

In Claude Code sessions, use these commands directly:

```
/remember nicholai prefers bun over npm
/recall coding preferences
```

These work via the built-in skills in `~/.agents/skills/`. The skill instructions tell Claude how to call the Signet daemon API.

### Prerequisites

- Claude Code installed and in `PATH`
- `~/.claude/` directory exists

---

## OpenCode

OpenCode is an open-source AI coding tool. Signet integrates via a plugin and AGENTS.md sync.

### Files managed by Signet

| File | Description |
|------|-------------|
| `~/.config/opencode/AGENTS.md` | Auto-synced from `~/.agents/AGENTS.md` |
| `~/.config/opencode/memory.mjs` | Plugin providing remember/recall tools |

### Plugin

`memory.mjs` is an ES module plugin that OpenCode loads at startup. It registers `/remember` and `/recall` as native tools that call the Signet daemon.

Example of what the plugin does:

```javascript
// Provides /remember tool
async function remember(content, options = {}) {
  const res = await fetch('http://localhost:3850/api/memory/remember', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ content, who: 'opencode', ...options })
  });
  return res.json();
}

// Provides /recall tool
async function recall(query, options = {}) {
  const res = await fetch('http://localhost:3850/api/memory/recall', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ query, ...options })
  });
  return res.json();
}
```

### Prerequisites

- OpenCode installed
- `~/.config/opencode/` directory exists

---

## OpenClaw

OpenClaw is a desktop AI agent harness. Signet has the deepest integration here via the `@signet/adapter-openclaw` package and the full hooks system.

### Files managed by Signet

| Location | Description |
|----------|-------------|
| `~/.agents/AGENTS.md` | Source of truth (OpenClaw reads workspace directly) |
| `~/.agents/hooks/agent-memory/` | Hook handler directory |
| `~/.openclaw/openclaw.json` | Workspace configuration |

### Workspace configuration

Signet sets the OpenClaw workspace to `~/.agents/` in the OpenClaw config:

```json
{
  "agents": {
    "defaults": {
      "workspace": "~/.agents"
    }
  }
}
```

OpenClaw checks these config locations (in order):
- `~/.openclaw/openclaw.json`
- `~/.clawdbot/clawdbot.json`
- `~/.moltbot/moltbot.json`

### @signet/adapter-openclaw

The adapter package provides a full lifecycle integration:

```javascript
import createPlugin from '@signet/adapter-openclaw';

const signet = createPlugin({
  enabled: true,
  daemonUrl: 'http://localhost:3850'  // default
});
```

**Session start** — inject memories into system prompt:
```javascript
const result = await signet.onSessionStart({
  harness: 'openclaw',
  sessionKey: session.id
});
// result.inject → prepend to system prompt
```

**Pre-compaction** — get summary guidelines:
```javascript
const guide = await signet.onPreCompaction({
  harness: 'openclaw',
  messageCount: messages.length
});
// guide.summaryPrompt → use as compaction instruction
```

**Compaction complete** — save the generated summary:
```javascript
await signet.onCompactionComplete({
  harness: 'openclaw',
  summary: generatedSummary,
  sessionKey: session.id
});
```

**Manual memory operations:**
```javascript
await signet.remember('nicholai prefers bun', { who: 'openclaw' });
const results = await signet.recall('coding preferences');
```

### MEMORY.md synthesis

OpenClaw is the default harness for MEMORY.md synthesis. On the configured schedule, OpenClaw:

1. Calls `GET /api/hooks/synthesis/config` to check if synthesis should run
2. Calls `POST /api/hooks/synthesis` to get the synthesis prompt
3. Runs the prompt through the configured model
4. Posts the result to `POST /api/hooks/synthesis/complete`

This keeps MEMORY.md up to date with a coherent summary of your memory database.

### Hooks directory

During setup, Signet creates `~/.agents/hooks/agent-memory/` with:

- `HOOK.md` — hook documentation
- `handler.js` — event handler (for older hook-based integration)
- `package.json` — package metadata

### Package Distinction: adapter vs connector

Signet provides two separate packages for OpenClaw integration:

#### @signet/connector-openclaw

**Purpose:** Setup and installation

This is a setup-time package that:

- Patches OpenClaw config files (openclaw.json, clawdbot.json, moltbot.json)
- Sets `agents.defaults.workspace` to ~/.agents
- Enables the `signet-memory` internal hook entry
- Installs hook handler files under `~/.agents/hooks/agent-memory/`

Installed during `signet setup` when OpenClaw is selected.

#### @signet/adapter-openclaw

**Purpose:** Runtime plugin

This is a runtime plugin that OpenClaw loads to:

- Call the Signet daemon API for /remember, /recall operations
- Handle lifecycle hooks (session start, compaction, etc.)
- Inject memories into the system prompt

Has a peer dependency on `openclaw` — only usable within the OpenClaw process.

---

## Cursor (Planned)

Signet will sync your agent identity to `.cursorrules` in your project directories. Configuration and hooks planned for a future release.

---

## Windsurf (Planned)

Windsurf integration is planned. Similar to Cursor — file-based identity sync and possibly a plugin for memory access.

---

## Adding a New Harness

To integrate Signet with a harness not listed here:

1. **Identity sync** — simply watch for `~/.agents/AGENTS.md` changes and copy the content to wherever your harness reads agent instructions.

2. **Memory access** — call the daemon's HTTP API:
   - `POST /api/memory/remember` to save memories
   - `POST /api/memory/recall` to search memories

3. **Lifecycle hooks** — call the hooks API at session events:
   - `POST /api/hooks/session-start` at session start
   - `POST /api/hooks/pre-compaction` before compaction
   - `POST /api/hooks/compaction-complete` after compaction

4. **Check daemon health** — always verify `GET /health` returns 200 before making other calls.

See [API.md](./API.md) for full endpoint documentation and [HOOKS.md](./HOOKS.md) for hook integration details.

---

## Harness Status

Check which harnesses are configured:

```bash
signet status
```

Or via API:

```bash
curl http://localhost:3850/api/harnesses
```

Or in the dashboard under the **Harnesses** section.
