---
import NavSearch from './NavSearch.tsx';
---

<div id="nav-peek-zone" class="nav-peek-zone" aria-hidden="true"></div>
<div id="nav-wrapper" class="site-nav-wrapper">
  <nav class="site-nav" aria-label="Primary navigation">
    <a href="/" class="nav-brand" aria-label="Signet home">
      <span class="nav-brand-text">SignetAI</span>
    </a>

    <div class="nav-divider" aria-hidden="true"></div>

    <div class="nav-links">
      <a href="/docs">Docs</a>
      <a href="https://github.com/Signet-AI/signetai/tree/main/spec">Spec</a>
    </div>

    <div class="nav-divider" aria-hidden="true"></div>

    <NavSearch client:idle />

    <div class="nav-theme-switch" role="group" aria-label="Theme mode">
      <button type="button" class="nav-theme-btn" data-theme-value="light" aria-pressed="false">
        Light
      </button>
      <button type="button" class="nav-theme-btn" data-theme-value="dark" aria-pressed="false">
        Dark
      </button>
    </div>

    <a href="https://github.com/Signet-AI/signetai" class="nav-github">
      GitHub
      <svg class="nav-github-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M7 17L17 7M17 7H7M17 7v10"/></svg>
    </a>

    <button id="nav-mobile-toggle" class="nav-mobile-toggle" aria-label="Toggle menu" aria-expanded="false" aria-controls="nav-mobile-menu">
      <span class="nav-line" id="nav-line-1"></span>
      <span class="nav-line" id="nav-line-2"></span>
    </button>
  </nav>

  <div id="nav-mobile-menu" class="nav-mobile-menu" aria-hidden="true">
    <div class="nav-mobile-links">
      <a href="/docs" class="nav-mobile-link">Docs</a>
      <a href="https://github.com/Signet-AI/signetai/tree/main/spec" class="nav-mobile-link">Spec</a>
      <a href="https://github.com/Signet-AI/signetai" class="nav-mobile-link">
        GitHub
        <svg class="nav-mobile-link-arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M7 17L17 7M17 7H7M17 7v10"/></svg>
      </a>
    </div>
    <div class="nav-mobile-footer">
      <button type="button" class="nav-mobile-theme-toggle" data-theme-value="light" aria-label="Switch to light mode" aria-pressed="false">
        <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><circle cx="10" cy="10" r="4"/><path d="M10 1v2M10 17v2M1 10h2M17 10h2M3.93 3.93l1.41 1.41M14.66 14.66l1.41 1.41M3.93 16.07l1.41-1.41M14.66 5.34l1.41-1.41"/></svg>
      </button>
      <button type="button" class="nav-mobile-theme-toggle" data-theme-value="dark" aria-label="Switch to dark mode" aria-pressed="false">
        <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M17.29 13.35A8 8 0 116.65 2.71a6 6 0 0010.64 10.64z"/></svg>
      </button>
    </div>
  </div>
</div>

<script>
  const NAV_OPEN_CLASS = 'nav-open';
  const NAV_HIDDEN_CLASS = 'nav-hidden';

  let navCleanup: (() => void) | null = null;

  function isMobileViewport() {
    return window.matchMedia('(max-width: 720px)').matches;
  }

  function setMobileMenuOpen(isOpen: boolean) {
    const menu = document.getElementById('nav-mobile-menu');
    const toggle = document.getElementById('nav-mobile-toggle');
    const wrapper = document.getElementById('nav-wrapper');
    if (!menu || !toggle) return;

    if (isOpen) {
      document.documentElement.classList.add(NAV_OPEN_CLASS);
      wrapper?.classList.remove(NAV_HIDDEN_CLASS);
      menu.setAttribute('aria-hidden', 'false');
      toggle.setAttribute('aria-expanded', 'true');
      return;
    }

    document.documentElement.classList.remove(NAV_OPEN_CLASS);
    menu.setAttribute('aria-hidden', 'true');
    toggle.setAttribute('aria-expanded', 'false');
  }

  function getCurrentTheme() {
    return document.documentElement.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
  }

  function syncThemeButtons() {
    const current = getCurrentTheme();
    document.querySelectorAll<HTMLElement>('[data-theme-value]').forEach((button) => {
      const value = button.dataset.themeValue;
      const isActive = value === current;
      button.classList.toggle('is-active', isActive);
      button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
  }

  function setThemeFromNav(theme: string) {
    if (typeof window.setTheme === 'function') {
      window.setTheme(theme, true);
    } else {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('signet-theme', theme);
    }
    syncThemeButtons();
  }

  function bindThemeButtons() {
    document.querySelectorAll<HTMLElement>('[data-theme-value]').forEach((button) => {
      if (button.dataset.boundTheme === 'true') return;
      button.dataset.boundTheme = 'true';
      button.addEventListener('click', () => {
        const theme = button.dataset.themeValue;
        if (!theme) return;
        setThemeFromNav(theme);
      });
    });
    syncThemeButtons();
  }

  function bindNavBehavior() {
    if (typeof navCleanup === 'function') {
      navCleanup();
      navCleanup = null;
    }

    const wrapper = document.getElementById('nav-wrapper');
    const nav = wrapper?.querySelector('.site-nav');
    const peekZone = document.getElementById('nav-peek-zone');
    const toggle = document.getElementById('nav-mobile-toggle');
    const menu = document.getElementById('nav-mobile-menu');
    if (!wrapper || !nav || !toggle || !menu || !peekZone) return;

    let lastScrollY = window.scrollY;
    let hoverPinned = false;
    let ticking = false;

    const applyByScrollDirection = (scrollY: number) => {
      if (document.documentElement.classList.contains(NAV_OPEN_CLASS)) {
        wrapper.classList.remove(NAV_HIDDEN_CLASS);
        return;
      }

      if (isMobileViewport()) {
        wrapper.classList.remove(NAV_HIDDEN_CLASS);
        return;
      }

      if (hoverPinned || scrollY < 36) {
        wrapper.classList.remove(NAV_HIDDEN_CLASS);
        return;
      }

      const delta = scrollY - lastScrollY;
      if (delta > 6 && scrollY > 120) {
        wrapper.classList.add(NAV_HIDDEN_CLASS);
      } else if (delta < -6) {
        wrapper.classList.remove(NAV_HIDDEN_CLASS);
      }
    };

    const onScroll = () => {
      if (ticking) return;
      ticking = true;
      window.requestAnimationFrame(() => {
        const scrollY = window.scrollY;
        applyByScrollDirection(scrollY);
        lastScrollY = scrollY;
        ticking = false;
      });
    };

    const onResize = () => {
      if (isMobileViewport()) {
        wrapper.classList.remove(NAV_HIDDEN_CLASS);
        return;
      }
      applyByScrollDirection(window.scrollY);
    };

    const pinVisible = () => {
      hoverPinned = true;
      wrapper.classList.remove(NAV_HIDDEN_CLASS);
    };

    const unpinVisible = () => {
      hoverPinned = false;
      applyByScrollDirection(window.scrollY);
    };

    toggle.addEventListener('click', () => {
      const open = !document.documentElement.classList.contains(NAV_OPEN_CLASS);
      setMobileMenuOpen(open);
    });

    menu.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => setMobileMenuOpen(false));
    });

    const onKeyDown = (event: KeyboardEvent) => {
      if (event.key === 'Escape') setMobileMenuOpen(false);
    };

    bindThemeButtons();

    wrapper.addEventListener('mouseenter', pinVisible);
    wrapper.addEventListener('mouseleave', unpinVisible);
    peekZone.addEventListener('mouseenter', pinVisible);
    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', onResize);
    document.addEventListener('keydown', onKeyDown);

    onResize();

    navCleanup = () => {
      wrapper.removeEventListener('mouseenter', pinVisible);
      wrapper.removeEventListener('mouseleave', unpinVisible);
      peekZone.removeEventListener('mouseenter', pinVisible);
      window.removeEventListener('scroll', onScroll);
      window.removeEventListener('resize', onResize);
      document.removeEventListener('keydown', onKeyDown);
    };
  }

  bindNavBehavior();
  document.addEventListener('astro:page-load', () => {
    setMobileMenuOpen(false);
    bindNavBehavior();
  });
</script>
