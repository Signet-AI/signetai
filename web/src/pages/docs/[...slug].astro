---
import { getCollection, render } from 'astro:content';
import Docs from '../../layouts/Docs.astro';
import StructuredData from '../../components/StructuredData.astro';
import { buildDocsNav, getDocNeighbors } from '../../lib/docs-nav';

export async function getStaticPaths() {
  const docs = await getCollection('docs');
  return docs.map(doc => ({
    params: { slug: doc.id.replace(/\.md$/, '').toLowerCase() },
    props: { doc },
  }));
}

const { doc } = Astro.props;
const { Content, headings } = await render(doc);
const currentSlug = doc.id.replace(/\.md$/, '').toLowerCase();
const allDocs = await getCollection('docs');
const { flat } = buildDocsNav(allDocs);
const { previous, next } = getDocNeighbors(flat, currentSlug);
const toc = headings
  .filter((heading) => heading.depth === 2 || heading.depth === 3)
  .slice(0, 24);

const siteUrl = Astro.site?.toString().replace(/\/$/, '') ?? 'https://www.signetai.sh';
const pageUrl = `${siteUrl}/docs/${currentSlug}/`;
---

<Docs
  title={doc.data.title}
  description={doc.data.description}
  currentSlug={currentSlug}
  currentSection={doc.data.section}
  toc={toc}
  previousDoc={previous}
  nextDoc={next}
>
  <StructuredData data={{
    '@context': 'https://schema.org',
    '@type': 'TechArticle',
    headline: doc.data.title,
    description: doc.data.description ?? `Signet documentation: ${doc.data.title}`,
    url: pageUrl,
    publisher: {
      '@type': 'Organization',
      name: 'SignetAI',
      url: siteUrl,
    },
  }} />
  <StructuredData data={{
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    itemListElement: [
      { '@type': 'ListItem', position: 1, name: 'Home', item: siteUrl },
      { '@type': 'ListItem', position: 2, name: 'Docs', item: `${siteUrl}/docs/` },
      { '@type': 'ListItem', position: 3, name: doc.data.title, item: pageUrl },
    ],
  }} />
  <Content />
</Docs>
